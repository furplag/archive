FROM furplag/steamcmd:latest
###
# wined-valheim-aarch64.oci.ampere/Dockerfile
# https://github.com/furplag/archive/docker
#
# Licensed under CC-BY-NC-SA 4.0 ( https://creativecommons.org/licenses/by-nc-sa/4.0/ )
#
# running Valheim dedicated server on arm64/v8 instance ( especially for A1.Flex-ampere.OracleLinux  ) .
#
# Requirement
# [ ] a base image "furplag/steamcmd:latest" should be build before this image .
# [ ] a Docker Volume to persists game data ( recommends to use docker compose ) .
#
# Usage
# A. docker compose up -d --name {container} \
#    -p 2456-2457:2456-2457/tcp \
#    -p 2456-2457:2456-2457/udp \
#    server
#

###
# ENV / variable
###
# general
ARG DEBIAN_FRONTEND=noninteractive
ARG TZ=Etc/UTC
ARG LANG='en_US.UTF-8'
ARG LANGUAGE='en_US:en'

# steamcmd
ARG STEAM_HOME=/opt/steam
ARG STEAM_USER=steam
ARG STEAMCMD_HOME="${STEAM_HOME}/steamcmd"
ARG STEAM_LIBS_86="${STEAMCMD_HOME}/linux32"
ARG STEAM_LIBS_64="${STEAMCMD_HOME}/linux64"

# valheim ( steamapp )
ARG STEAMAPP_ID=896660
ARG SteamAppId=892970
ARG STEAMAPP_NAME=valheim
ARG STEAMAPP_HOME="${STEAM_HOME}/${STEAMAPP_NAME}"
ARG STEAMAPP_PLATFORM_TYPE=linux
ARG STEAMAPP_UPDATE_ENABLED='TRUE'

# valheim ( server options )
ARG VALHEIM_NAME=Valheim
ARG VALHEIM_WORLD=Dedicated
ARG VALHEIM_PASSWORD=s3CRet
ARG VALHEIM_PORT=2456
ARG VALHEIM_PORT_ASIDE=2457
ARG VALHEIM_IS_PUBLIC='FALSE'
ARG VALHEIM_CROSSPLAY_ENABLED='FALSE'
ARG VALHEIM_SAVE_DIR="${STEAMAPP_HOME}/_saves"
ARG VALHEIM_SAVE_INTERVAL=1800
ARG VALHEIM_BACKUPS=4
ARG VALHEIM_BACKUP_SHORT=7200
ARG VALHEIM_BACKUP_LONG=43200
ARG VALHEIM_LOG_DIR="${STEAMAPP_HOME}/_logs"

ARG VALHEIM_MODIFIER_COMBAT=
ARG VALHEIM_MODIFIER_DEATHPENALTY=
ARG VALHEIM_MODIFIER_PORTALS=
ARG VALHEIM_MODIFIER_RAIDS=
ARG VALHEIM_MODIFIER_RESOURCES=

ARG VALHEIM_MODIFIER_NOBUILDCOST='FALSE'
ARG VALHEIM_MODIFIER_PLAYEREVENTS='FALSE'
ARG VALHEIM_MODIFIER_PASSIVEMOBS='FALSE'
ARG VALHEIM_MODIFIER_NOMAP='FALSE'

# Box64
ARG BOX64_NOBANNER=1
ARG BOX64_DYNAREC_BIGBLOCK=0
ARG BOX64_DYNAREC_BLEEDING_EDGE=0
ARG BOX64_DYNAREC_STRONGMEM=2
ARG BOX64_DYNAREC_CALLRET=1
ARG BOX64_DYNAREC_FASTROUND=1
ARG BOX64_DYNAREC_FASTNAN=1
ARG BOX64_DYNAREC_SAFEFLAGS=1
ARG BOX64_DYNAREC_X87DOUBLE=0
ARG BOX64_LOG=0
ARG BOX64_TRACE_FILE=

ENV TZ=${TZ}
ENV LANG=${LANG}
ENV LANGUAGE=${LANGUAGE}

ENV STEAM_HOME=${STEAM_HOME}
ENV STEAM_USER=${STEAM_USER}
ENV STEAMCMD_HOME=${STEAMCMD_HOME}
ENV STEAM_LIBS_86=${STEAM_LIBS_86}
ENV STEAM_LIBS_64=${STEAM_LIBS_64}

ENV STEAMAPP_ID=${STEAMAPP_ID}
ENV SteamAppId=${SteamAppId}
ENV STEAMAPP_NAME=${STEAMAPP_NAME}
ENV STEAMAPP_HOME=${STEAMAPP_HOME}
ENV STEAMAPP_PLATFORM_TYPE=${STEAMAPP_PLATFORM_TYPE}
ENV STEAMAPP_UPDATE_ENABLED=${STEAMAPP_UPDATE_ENABLED}

ENV VALHEIM_NAME=${VALHEIM_NAME}
ENV VALHEIM_WORLD=${VALHEIM_WORLD}
ENV VALHEIM_PASSWORD=${VALHEIM_PASSWORD}
ENV VALHEIM_PORT=${VALHEIM_PORT}
ENV VALHEIM_PORT_ASIDE=${VALHEIM_PORT_ASIDE}
ENV VALHEIM_IS_PUBLIC=${VALHEIM_IS_PUBLIC}
ENV VALHEIM_CROSSPLAY_ENABLED=${VALHEIM_CROSSPLAY_ENABLED}
ENV VALHEIM_SAVE_DIR=${VALHEIM_SAVE_DIR}
ENV VALHEIM_SAVE_INTERVAL=${VALHEIM_SAVE_INTERVAL}
ENV VALHEIM_BACKUPS=${VALHEIM_BACKUPS}
ENV VALHEIM_BACKUP_SHORT=${VALHEIM_BACKUP_SHORT}
ENV VALHEIM_BACKUP_LONG=${VALHEIM_BACKUP_LONG}
ENV VALHEIM_LOG_DIR=${VALHEIM_LOG_DIR}
ENV VALHEIM_MODIFIER_COMBAT=${VALHEIM_MODIFIER_COMBAT}
ENV VALHEIM_MODIFIER_DEATHPENALTY=${VALHEIM_MODIFIER_DEATHPENALTY}
ENV VALHEIM_MODIFIER_PORTALS=${VALHEIM_MODIFIER_PORTALS}
ENV VALHEIM_MODIFIER_RAIDS=${VALHEIM_MODIFIER_RAIDS}
ENV VALHEIM_MODIFIER_RESOURCES=${VALHEIM_MODIFIER_RESOURCES}
ENV VALHEIM_MODIFIER_NOBUILDCOST=${VALHEIM_MODIFIER_NOBUILDCOST}
ENV VALHEIM_MODIFIER_PLAYEREVENTS=${VALHEIM_MODIFIER_PLAYEREVENTS}
ENV VALHEIM_MODIFIER_PASSIVEMOBS=${VALHEIM_MODIFIER_PASSIVEMOBS}
ENV VALHEIM_MODIFIER_NOMAP=${VALHEIM_MODIFIER_NOMAP}
ENV VALHEIM_SERVER_UPDATE_ENABLED=${VALHEIM_SERVER_UPDATE_ENABLED}

ENV BOX64_NOBANNER=${BOX64_NOBANNER}
ENV BOX64_DYNAREC_BIGBLOCK=${BOX64_DYNAREC_BIGBLOCK}
ENV BOX64_DYNAREC_BLEEDING_EDGE=${BOX64_DYNAREC_BLEEDING_EDGE}
ENV BOX64_DYNAREC_STRONGMEM=${BOX64_DYNAREC_STRONGMEM}
ENV BOX64_DYNAREC_CALLRET=${BOX64_DYNAREC_CALLRET}
ENV BOX64_DYNAREC_FASTROUND=${BOX64_DYNAREC_FASTROUND}
ENV BOX64_DYNAREC_FASTNAN=${BOX64_DYNAREC_FASTNAN}
ENV BOX64_DYNAREC_SAFEFLAGS=${BOX64_DYNAREC_SAFEFLAGS}
ENV BOX64_DYNAREC_X87DOUBLE=${BOX64_DYNAREC_X87DOUBLE}
ENV BOX64_LOG=${BOX64_LOG}
ENV BOX64_TRACE_FILE=${BOX64_TRACE_FILE}

# packages
WORKDIR /
USER root
RUN apt-get update && apt-get upgrade -y && apt-get dist-upgrade -y && \
  libasyncns0 libatomic1 libglib2.0-0 libpulse0 libpulse-dev libpulse-mainloop-glib0 && \
  # cleanup
  apt-get autoremove --purge -y && apt-get clean autoclean && rm -rf /tmp/* /var/tmp/* /var/lib/apt/lists/*;

# scripts
WORKDIR ${STEAM_HOME}
USER ${STEAM_USER}
RUN for _script in 'valheim_server.aarch64' 'valheim_server.update'; do curl -fL "https://github.com/furplag/archive/raw/master/docker/valheim-aarch64.oci.ampere/${_script}" -o "${STEAM_HOME}/${_script}" && chmod +x "${STEAM_HOME}/${_script}"; done;

# box64 environment
RUN echo '[valheim_server.x86_64]' >${HOME}/.box64rc && \
  echo "BOX64_DYNAREC_BIGBLOCK=${BOX64_DYNAREC_BIGBLOCK:-0}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_BLEEDING_EDGE=${BOX64_DYNAREC_BLEEDING_EDGE:-0}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_STRONGMEM=${BOX64_DYNAREC_STRONGMEM:-2}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_CALLRET=${BOX64_DYNAREC_CALLRET;-1}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_FASTNAN=${BOX64_DYNAREC_FASTNAN:-1}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_FASTROUND=${BOX64_DYNAREC_FASTROUND:-1}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_SAFEFLAGS=${BOX64_DYNAREC_SAFEFLAGS:-1}" >>${STEAM_HOME}/.box64rc && \
  echo "BOX64_DYNAREC_X87DOUBLE=${BOX64_DYNAREC_X87DOUBLE:-0}" >>${STEAM_HOME}/.box64rc && \
  if [[ ! "${BOX64_LOG:-0}" = "0" ]] && [ -n "${BOX64_TRACE_FILE:-}" ]; then echo "BOX64_LOG=${BOX64_LOG}" >>${STEAM_HOME}/.box64rc; echo "BOX64_TRACE_FILE=${BOX64_TRACE_FILE}" >>${STEAM_HOME}/.box64rc; fi;

# cleanup image
WORKDIR /
USER root
RUN apt-get autoremove --purge -y && apt-get clean autoclean && rm -rf /tmp/* /var/tmp/* /var/lib/apt/lists;

# ports
EXPOSE ${VALHEIM_PORT}-${VALHEIM_PORT_ASIDE}/udp

# current user / directory
WORKDIR ${STEAM_HOME}
USER ${STEAM_USER}

# healthcheck ( WiP )
HEALTHCHECK --start-period=1m --interval=30s --timeout=1s CMD [ `ps ax | grep 'valheim_server.x86_64' | grep -v grep | wc -l` -eq 1 ] || exit 1

# entrypoint
ENTRYPOINT [ "bash", "/opt/steam/valheim_server.aarch64" ]
